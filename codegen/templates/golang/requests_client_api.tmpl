{{- define "requests_client_api" -}}
// DO NOT EDIT THIS FILE. This file will be overwritten when re-running go-raml.
package {{.PackageName}}

{{$apiName := .Name}}
import (
	{{ if .NeedImportJSON}}"encoding/json"{{end}}
    "github.com/hotmall/requests"

    {{ range $k, $v := .Imports -}}
     {{$v}}
    {{end -}}
)

// {{$apiName}} represents an API structure 
type {{$apiName}} struct {
	baseURI string
}

// New{{$apiName}} new an API object
func New{{$apiName}}(host string) {{$apiName}} {
    return {{$apiName}}{
        baseURI: host+"{{.BaseURI}}",
    }
}

{{ range $k, $v := .Methods }}
{{ range $kf, $vf := $v.FuncComments }}
// {{$v.MethodName}} {{$vf}} {{end}}
func (s {{$apiName}}) {{$v.MethodName}}(reqContext *types.{{$v.MethodName}}Context{{if .ReqBody}}, reqBody {{.ReqBody}}{{end}}) (respHeader map[string]string{{if .RespBody}}, respBody {{.RespBody}}{{end}}, err error) {

    {{- range $kq, $vq := $v.QueryParameters }}
        p := make(requests.Params)
    {{- if eq $vq.Type "integer"}}
        p["{{$kq}}"] = strconv.Itoa(reqContext.{{$kq|Camelize}})
    {{- else}}
        p["{{$kq}}"] = reqContext.{{$kq|Camelize}}
    {{- end}}
    {{- end }}

    {{- range $kq, $vq := $v.Headers }}
        h := make(requests.Header)
	{{- if eq $vq.Type "integer"}}
        h["{{$kq}}"] = strconv.Itoa(reqContext.{{$kq|printf "%s"|Camelize}})
	{{- else}}
        h["{{$kq}}"] = reqContext.{{$kq|printf "%s"|Camelize}}
	{{- end}}
	{{- end }}

    {{- range $kq, $vq := $v.URIParameters }}
	{{- if eq $vq.Type "integer"}}
        {{$kq|CamelizeDownFirst}} := strconv.Itoa(reqContext.{{$kq|Camelize}})
	{{- else}}
        {{$kq|CamelizeDownFirst}} := reqContext.{{$kq|Camelize}}
	{{- end}}
	{{- end }}

    {{if ne $v.ReqBody ""}}
    if err = reqBody.Validate(); err != nil {
        return
    }
    jsonBody, err := json.Marshal(reqBody)
    if err != nil {
        return
    }
    {{- end}}

    {{$lenParams := len $v.QueryParameters}}
    {{$lenHeader := len $v.Headers}}
    resp, err := requests.Request("{{$v.Verb}}", s.baseURI {{$v.Route}}{{if gt $lenParams 0}}, p{{end}}{{if gt $lenHeader 0}}, h{{end}}{{if .ReqBody}}, requests.JSON(jsonBody){{end}})
    if err != nil {
        return
    }

    respHeader = make(requests.Header, len(resp.Header))
    for hk, hv := range resp.Header {
        respHeader[hk] = hv
    }

    if resp.StatusCode != {{.FirstSuccessRespStatus}} {
        err = goraml.NewAPIError(resp, nil)
        return
    }

    {{ if $v.HasRespBody }}
    if err = json.Unmarshal(resp.Content(), &respBody); err != nil {
        return
    }
    {{- end}}
    return
}
{{- end -}}
{{- end -}}
