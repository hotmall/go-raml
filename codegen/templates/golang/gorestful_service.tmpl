{{- define "gorestful_service_template" -}}
// THIS FILE IS SAFE TO EDIT. It will not be overwritten when rerunning go-raml.
package service

import (
    {{ range $k, $v := .ServiceImporters -}}
        {{$v}}
    {{end}}
)
{{$apiName := .Name}}
// {{.Name}}Service is Service implementation of {{.Endpoint}} root endpoint
type {{.Name}}Service struct {
	*restful.WebService
	delegator delegate.{{.Name}}Delegate
}

// New{{.Name}}Service create {{.Name}}Service object
func New{{.Name}}Service(delegator delegate.{{.Name}}Delegate) *{{.Name}}Service {
	ws := &{{.Name}}Service{
        WebService: new(restful.WebService),
        delegator: delegator,
    }

	ws.
		Path("{{.APIDef.BaseURI}}").
		Consumes("{{.APIDef.MediaType}}").
		Produces("{{.APIDef.MediaType}}")

	{{ range $k, $v := .Methods }}
	ws.Route(ws.{{$v.Verb}}("{{$v.Endpoint}}").To(ws.{{$v.MethodName}}))
	{{- end}}

	return ws
}

{{ range $k, $v := .Methods }}
// {{$v.MethodName}} is the handler for {{$v.Verb}} {{$v.Endpoint}}
{{- range $kf, $vf := $v.FuncComments}}
// {{$vf}}{{end}}
func (s {{$apiName}}Service) {{$v.MethodName}}(req *restful.Request, resp *restful.Response) {
	var reqContext types.{{$v.MethodName}}Context
	{{- range $kq, $vq := $v.QueryParameters }}
    {{$kq}} := req.QueryParameter("{{$kq}}")
	{{- if eq $vq.Type "integer"}}
	if {{$kq}} != "" {
		reqContext.{{$kq|Title}}, _ = strconv.Atoi({{$kq}})
	}
	{{- else}}
	reqContext.{{$kq|Title}} = {{$kq}}
	{{- end}}
	{{- end }}

	{{- range $kq, $vq := $v.URIParameters }}
    {{$kq}} := req.PathParameter("{{$kq}}")
	{{- if eq $vq.Type "integer"}}
	if {{$kq}} != "" {
		reqContext.{{$kq|Title}} = strconv.Atoi({{$kq}})
	}
	{{- else}}
	reqContext.{{$kq|Title}} = {{$kq}}
	{{- end}}
	{{- end }}

	// validate context
    if err := reqContext.Validate(); err != nil {
        resp.WriteHeader(400)
        resp.AddHeader("Content-Type", "application/json")
        resp.Write([]byte(`{"error":"`+err.Error()+`"}`))
        return
    }
	{{- if .ReqBody }}
	
	var reqBody {{.ReqBody}}
    // decode request
	if err := req.ReadEntity(&reqBody); err != nil {
		resp.WriteHeader(400)
        resp.AddHeader("Content-Type", "application/json")
        resp.Write([]byte(`{"error":"`+err.Error()+`"}`))
		return
	}
    {{ if .ReqBodyNeedValidation}}
    // validate request
    if err := reqBody.Validate(); err != nil {
        resp.WriteHeader(400)
        resp.AddHeader("Content-Type", "application/json")
        resp.Write([]byte(`{"error":"`+err.Error()+`"}`))
        return
    }
    {{- end }}
	{{- end }}

	respHeader{{if .RespBody}}, respBody{{end}}, err := s.delegator.{{$v.MethodName}}(reqContext{{if .ReqBody}}, reqBody{{end}})
	if err != nil {
        resp.WriteHeader(err.Status)
        resp.AddHeader("Content-Type", "application/json")
        resp.Write([]byte(`{"error":"`+err.Error()+`"}`))
        return
    }
	
	for k, v := range respHeader {
		resp.AddHeader(k, v)
	}

	{{- if .RespBody }}
	resp.AddHeader("Content-Type", "application/json")

	if err := resp.WriteEntity(respBody); err != nil {
		resp.WriteHeader(500)
        resp.AddHeader("Content-Type", "application/json")
        resp.Write([]byte(`{"error":"`+err.Error()+`"}`))
        return
	}
	{{- else}}
	resp.WriteHeader({{.FirstSuccessRespStatus}})
	{{- end }}
}
{{- end -}}
{{- end -}}
